' Gambas class file

Public listaProcesos As New Process[]
Public TotalProcesosActivos As Integer = 0
Public textolog As String

Public opcionesNombre As New String[]

Public Sub Form_Open()

    Settings.Read(Me)
    definirTableviewDatos()
    Me.Title = "Divisor Multiple de Pdf. Version " & Application.Version

    opcionesNombre.Add("PREFIJO-" & ".00 Memoria Explotacion " & "YYYY" & " Presa " & "ZZZZZ" & ".INDICE")
    opcionesNombre.Add("PREFIJO-" & ".00 Informe Anual " & "YYYY" & " Presa " & "ZZZZZ" & ".INDICE")
    opcionesNombre.Add("PREFIJO-" & ".01 Memoria")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo 0.Indice de Anejos")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Planos")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Datos Climaticos E Hidrologicos")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Datos De Explotacion")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Graficas de las variables de auscultacion")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Datos De Auscultacion")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Reportaje Fotografico")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Cronogramas de Inspecciones")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Cuadros de programacion y Cronogramas de Inspecciones")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Cronogramas de Mantenimiento")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Cuadros de programacion y Cronogramas de Mantenimiento")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Cronogramas de Inspecciones")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Informe Estado Sistema Auscultacion")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Informes Topografia")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Fichas Mantenimiento Correctivo")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Informe Calidad de Aguas")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Informe")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo X.Informe.IE")
    opcionesNombre.Add("PREFIJO-" & ".02 Anejo 06.Informe.IE")

End

Public Sub definirTableviewDatos()

    Dim i As Integer

    With TableViewDatos
        .header = 3
        .rows.count = 40
        .columns.count = 4
        .Columns[0].title = "Pag. Inicio"
        .Columns[1].title = "Pag. Final"
        .Columns[2].title = "Nombre Salida"
        .Columns[0].width = 120
        .Columns[1].width = 120
        .Columns[2].width = 630
        .Columns[3].width = 16
        .font.name = "Sans"
        .font.size = 9
        .Background = 16777215
        .Foreground = 0
        For I = 0 To .rows.count - 1
            .[I, 3].picture = Picture["CuboBasura.png"] 'elimina contenido de la fila
        Next

    End With

End

Public Sub Form_Close()

    Settings.Write(Me)

End

Public Sub ButtonFicheroOriginal_Click()

End

Public Sub ButtonEligeRuta_Click()

    If Dialog.SelectDirectory() Then
        'ha cancelado
    Else
        ButtonRuta.text = Dialog.Path

    Endif

End

Public Sub ButtonCargaPdf_Click()

    Dialog.Path = "/home/hdd/home/mint/Documentos/00 Trabajos/Cuarentena Trabajo/ute/02 SIPRESAS/Enlace hacia IA-firmados"
    Dialog.Filter = ["*.pdf;*.PDF", "PDFs"]
    If Dialog.OpenFile() Then
        'ha cancelado

        ButtonFicheroOriginal.text = Dialog.Path
        If ButtonRuta.text = "" Then
            'si esta vacia pongo la ruta del fichero que voy a abrir, sino no hago nada.
            ButtonRuta.text = File.Dir(Dialog.Path)
        Endif
        TextBoxYEAR.text = Mid$(File.BaseName(Dialog.Path), 3, 5)
        TextBoxPresa.text = parecidoNombrePresa(File.BaseName(Dialog.Path))
        valueboxAnejo.Value = 0
        TextBoxPrefijo.text = ""

        If Mid$(File.BaseName(Dialog.Path), 1, 2) = "ME" Then
            TableViewDatos[0, 2].text = "PREFIJO-" & ".00 Memoria Explotacion " & "YYYY" & " Presa " & "ZZZZZ" & ".INDICE"
            TableViewDatos[0, 0].text = "1"
        Endif
        If Mid$(File.BaseName(Dialog.Path), 1, 2) = "IA" Then
            TableViewDatos[0, 2].text = "PREFIJO-" & ".00 Informe Anual " & "YYYY" & " Presa " & "ZZZZZ" & ".INDICE"
            TableViewDatos[0, 0].text = "1"
        Endif
    Endif

End

Public Sub TableViewDatos_Click()

    If TableViewDatos.column = 2 Then
        TableViewDatos.Edit(opcionesNombre, False)
    Else
        If TableViewDatos.column = 3 Then
            TableViewDatos[TableViewDatos.Row, 0].text = ""
            tableViewDatos[TableViewDatos.Row, 1].text = ""
            TableViewDatos[TableViewDatos.Row, 2].text = ""
        Else

            TableViewDatos.EDIT
        Endif
    Endif

End

Public Sub TableViewDatos_Save(Row As Integer, Column As Integer, Value As String)

    ' If InStr(value, "Anejo") > 0 Then
    '     'reemplazo contador de anejos
    '     valueboxAnejo.Value = valueboxAnejo.Value + 0.5
    '     value = Replace(value, "X", Right("0" & Str$(valueboxAnejo.Value), 2))
    '
    ' Endif

    TableViewDatos[ROW, COLUMN].TEXT = VALUE

    'si estamos en la 1º columna, y la 2º columna del anterior fila esta vacia, le resto un 1
    If column = 0 Then
        If row > 0 Then
            If TableViewDatos[row - 1, 1].text = "" Then
                Try TableViewDatos[row - 1, 1].text = Str$(Val(TableViewDatos[row, 0].text) - 1) 'hace el intento, por si no hay numero
            Endif
        Endif
    Endif

End

Public Sub ButtonEjecutar_Click()

    Dim nombresalida As String
    Dim hproc As Process
    Dim a As Integer
    Dim resp As Integer

    If TextBoxPrefijo.text = "" Then
        resp = Message.Error("El prefijo esta en blanco, ¿continuar?", "Si", "No")
        If resp = 2 Then Return
    Endif

    listaProcesos.Clear()

    Spinner1.visible = True
    Spinner1.Start
    Timer1.Start()
    TotalProcesosActivos = 0
    'por cada linea del tableview, ejecuta el siguiente comando
    For a = 0 To TableViewDatos.rows.count - 1
        'comprobar lineas en blanco
        If TableViewDatos[a, 0].text = "" And TableViewDatos[a, 1].text = "" Then
            Print "linea en blanco... no hacer nada..."; a
        Else
            ''reemplazos
            nombresalida = Replace(TableViewDatos[a, 2].text, "PREFIJO-", TextBoxPrefijo.text)
            nombresalida = Replace(nombresalida, "YYYY", TextBoxYEAR.text)
            nombresalida = Replace(nombresalida, "ZZZZZ", TextBoxPresa.text)

            textolog &= gb.CrLf & "pdftk" & " " & "A=" & ButtonFicheroOriginal.text & " " & "cat" & " " & "A" & TableViewDatos[a, 0].text & "-" & TableViewDatos[a, 1].text & " " & "output" & " " & ButtonRuta.text & "/" & nombresalida & ".pdf" & gb.CrLf

            hproc = Exec ["pdftk", "A=" & ButtonFicheroOriginal.text, "cat", "A" & TableViewDatos[a, 0].text & "-" & TableViewDatos[a, 1].text, "output", ButtonRuta.text & "/" & nombresalida & ".pdf"]

            listaProcesos.Add(HPROC)
        Endif
    Next

    TotalProcesosActivos = listaProcesos.Count

    ' Message.Info("ok, en segundo plano se estan realizando los trabajos")

End

Public Function parecidoNombrePresa(nombre As String) As String

    If InStr(Upper(nombre), Upper("puebla")) <> 0 Then Return "Puebla De Cazalla"
    If InStr(Upper(nombre), Upper("agrio")) <> 0 Then Return "Agrio"
    If InStr(Upper(nombre), Upper("aracena")) <> 0 Then Return "Aracena"
    If InStr(Upper(nombre), Upper("huesn")) <> 0 Then Return "Huesna"
    If InStr(Upper(nombre), Upper("melon")) <> 0 Then Return "Melonares"
    If InStr(Upper(nombre), Upper("pinta")) <> 0 Then Return "Pintado"
    If InStr(Upper(nombre), Upper("flor")) <> 0 Then Return "Penaflor"
    If InStr(Upper(nombre), Upper("Torr")) <> 0 Then Return "TorreAguila"
    If InStr(Upper(nombre), Upper("Zufr")) <> 0 Then Return "Zufre"

End

Public Sub Label3_MouseDown()

End

Public Sub ButtonGuardaDiv_Click()

    Dim contenido As String = ""
    Dim linea As String = ""
    Dim a, b As Integer

    For a = 0 To TableViewDatos.rows.count - 1
        linea = ""
        For b = 0 To TableViewDatos.columns.count - 1
            linea &= TableViewDatos[a, b].text & gb.Tab
        Next
        contenido &= linea & "|"

    Next

    Settings["contenido"] = contenido

End

Public Sub ButtonCargaDiv_Click()

    Dim contenido As String
    Dim lineas As String[]
    Dim valores As String[]
    Dim a, b As Integer

    contenido = Settings["contenido", ""]
    lineas = Split(contenido, "|")

    For a = 0 To lineas.count - 1
        If lineas[a] = "" Then Return
        valores = Split(lineas[a], gb.Tab)
        For b = 0 To TableViewDatos.columns.count - 1
            TableViewDatos[a, b].text = valores[b]
        Next

    Next

End

Public Sub ButtonLimpiar_Click()

    ButtonFicheroOriginal.text = ""
    TextBoxPrefijo.text = ""
    valueboxAnejo.text = ""
    valueboxAnejo.text = ""
    limpiarTableViewDatos()
    TextBoxYEAR.text = ""
    TextBoxPresa.text = ""
    ButtonRuta.text = ""

    definirTableviewDatos()

End

Public Sub limpiarTableViewDatos()

    TableViewDatos.Clear

End

Public Sub ButtonVER_Click()

    Desktop.Open(ButtonFicheroOriginal.text)

End

Public Sub Spinner1_MouseDown()

End

Public Sub Timer1_Timer()

    Dim htmp As Process
    Dim a As Integer
    'comprobar

    For a = 0 To listaProcesos.count - 1
        Try htmp = listaProcesos[a]
        If Error Then Message.Info("No encuentro proceso en  Lista de Procesos ¿?")

        If htmp.State <> htmp.Running Then
            listaProcesos.Delete(a)
            Break 'salgo del bucle
        Endif
    Next

    If listaProcesos.count <= 0 Then
        Spinner1.Stop
        Spinner1.visible = False
        ProgressBar1.value = 0
        Timer1.Stop()
        music.load("fin.mp3")
        music.play
        Try Message.Info("Terminado de Procesar Ficheros")
    Else
        ProgressBar1.value = listaProcesos.count / TotalProcesosActivos
    Endif

End

Public Sub ButtonFicheroOriginal_Drop()

    ButtonFicheroOriginal.TEXT = Split(Drag.Data, "\r")[0]
    ButtonFicheroOriginal.TEXT = Replace(Replace(ButtonFicheroOriginal.TEXT, "%20", " "), "file://", "")
    If ButtonRuta.text = "" Then
        'si esta vacia pongo la ruta del fichero que voy a abrir, sino no hago nada.
        ButtonRuta.text = File.Dir(ButtonFicheroOriginal.TEXT)
    Endif
    TextBoxYEAR.text = Mid$(File.BaseName(ButtonFicheroOriginal.TEXT), 3, 5)
    TextBoxPresa.text = parecidoNombrePresa(File.BaseName(ButtonFicheroOriginal.TEXT))
    valueboxAnejo.Value = 0
    TextBoxPrefijo.text = ""
    If Mid$(File.BaseName(ButtonFicheroOriginal.TEXT), 1, 2) = "ME" Then
        TableViewDatos[0, 2].text = "PREFIJO-" & ".00 Memoria Explotacion " & "YYYY" & " Presa " & "ZZZZZ" & ".INDICE"
        TableViewDatos[0, 0].text = "1"
    Endif
    If Mid$(File.BaseName(ButtonFicheroOriginal.TEXT), 1, 2) = "IA" Then
        TableViewDatos[0, 2].text = "PREFIJO-" & ".00 Informe Anual " & "YYYY" & " Presa " & "ZZZZZ" & ".INDICE"
        TableViewDatos[0, 0].text = "1"
    Endif

End

Public Sub ButtonLimpiarNumeros_Click()

    Dim a As Integer

    For a = 0 To TableViewDatos.rows.count - 1
        TableViewDatos[a, 0].text = ""
        TableViewDatos[a, 1].text = ""
    Next

End

Public Sub ButtonNumerar_Click()

    Dim value As String
    Dim i As Integer

    For i = 0 To TableViewDatos.rows.count - 1
        value = TableViewDatos[i, 2].text

        If InStr(value, "Anejo X") > 0 Then
            'reemplazo contador de anejos
            valueboxAnejo.Value = valueboxAnejo.Value + 1
            TableViewDatos[i, 2].text = Replace(value, "X", Right("0" & Str$(valueboxAnejo.Value), 2))

        Endif
    Next

End

Public Sub PictureBox1_MouseDown()

    FormLOG.texto = textolog
    FormLOG.Show()

End

Public Sub ButtonAyuda_Click()

    ChekearGithub.comprobar("https://raw.githubusercontent.com/jsbsan/dividemultiplepdf/master/.project")

End

Public Sub ButtonRutaFichero_Click()

    ButtonRuta.text = File.Dir(ButtonFicheroOriginal.text)

End
